# üîß PHASE 2 : CONFIGURATION DU PROJET - GUIDE D√âTAILL√â

## üìã OBJECTIF DE CETTE PHASE

Connecter votre application CRMPro2x React √† votre base de donn√©es Supabase en configurant :
1. Les d√©pendances n√©cessaires
2. Les variables d'environnement
3. Le client Supabase
4. La v√©rification de la connexion

**Dur√©e estim√©e : 10-15 minutes**

---

## ‚úÖ PR√âREQUIS

Avant de commencer la Phase 2, assurez-vous que :

- [ ] La Phase 1 est termin√©e (base de donn√©es cr√©√©e dans Supabase)
- [ ] Vous avez not√© votre **SUPABASE_URL**
- [ ] Vous avez not√© votre **SUPABASE_ANON_KEY**
- [ ] Votre projet CRMPro2x est ouvert dans votre √©diteur de code
- [ ] Un terminal est ouvert √† la racine du projet

---

## üì¶ √âTAPE 1 : INSTALLER LES D√âPENDANCES

### Action 1.1 : Installer Supabase Client

Ouvrez un terminal √† la racine de votre projet et ex√©cutez :

```bash
npm install @supabase/supabase-js
```

**R√©sultat attendu :**
```
added 1 package, and audited 523 packages in 3s

154 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities
```

### Action 1.2 : V√©rifier l'installation

V√©rifiez que le package est bien install√© :

```bash
npm list @supabase/supabase-js
```

**R√©sultat attendu :**
```
crmpro2x@1.0.0 /chemin/vers/votre/projet
‚îî‚îÄ‚îÄ @supabase/supabase-js@2.x.x
```

‚úÖ **√âTAPE 1 TERMIN√âE**

---

## üîê √âTAPE 2 : CONFIGURER LES VARIABLES D'ENVIRONNEMENT

### Action 2.1 : Cr√©er le fichier .env.local

√Ä la **racine de votre projet** (m√™me niveau que package.json), cr√©ez un nouveau fichier nomm√© `.env.local`

**Structure du projet :**
```
crmpro2x/
‚îú‚îÄ‚îÄ node_modules/
‚îú‚îÄ‚îÄ public/
‚îú‚îÄ‚îÄ src/
‚îú‚îÄ‚îÄ .env.local          ‚Üê CR√âEZ CE FICHIER ICI
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ vite.config.ts
‚îî‚îÄ‚îÄ ...
```

### Action 2.2 : Ajouter vos cl√©s Supabase

Copiez-collez ce contenu dans `.env.local` :

```env
# Configuration Supabase pour CRMPro2x
VITE_SUPABASE_URL=https://votre-projet.supabase.co
VITE_SUPABASE_ANON_KEY=votre_cle_anonyme_ici
```

### Action 2.3 : Remplacer par vos vraies cl√©s

**IMPORTANT** : Remplacez les valeurs par vos vraies cl√©s r√©cup√©r√©es en Phase 1.

**O√π trouver vos cl√©s ?**
1. Allez sur https://supabase.com
2. S√©lectionnez votre projet
3. Cliquez sur **Settings** (‚öôÔ∏è) en bas de la barre lat√©rale
4. Allez dans **API**
5. Copiez :
   - **Project URL** ‚Üí `VITE_SUPABASE_URL`
   - **anon public** ‚Üí `VITE_SUPABASE_ANON_KEY`

**Exemple de fichier .env.local correctement rempli :**
```env
VITE_SUPABASE_URL=https://xyzcompany.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5emNvbXBhbnkiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTYzOTU4OTI0MCwiZXhwIjoxOTU1MTY1MjQwfQ.abc123def456ghi789jkl012mno345pqr678stu901vwx234
```

### Action 2.4 : V√©rifier que .env.local est ignor√© par Git

Ouvrez votre fichier `.gitignore` et v√©rifiez que cette ligne est pr√©sente :

```
.env.local
```

Si elle n'y est pas, ajoutez-la !

‚ö†Ô∏è **CRITIQUE** : Ne commitez JAMAIS le fichier .env.local dans Git !

‚úÖ **√âTAPE 2 TERMIN√âE**

---

## üìù √âTAPE 3 : CONFIGURER LE CLIENT SUPABASE

### Action 3.1 : Localiser le fichier client existant

Dans votre projet, naviguez vers :
```
src/integrations/supabase/client.ts
```

### Action 3.2 : Sauvegarder l'ancien fichier (optionnel)

Si vous voulez garder une copie de l'ancien fichier :

**Option A - Via terminal :**
```bash
cp src/integrations/supabase/client.ts src/integrations/supabase/client.ts.backup
```

**Option B - Via √©diteur :**
Dupliquez le fichier et renommez-le `client.ts.backup`

### Action 3.3 : Remplacer par le nouveau client

Ouvrez `src/integrations/supabase/client.ts` et **REMPLACEZ TOUT LE CONTENU** par le code suivant :

```typescript
// ============================================================================
// CLIENT SUPABASE - Configuration pour CRMPro2x
// ============================================================================
// Ce fichier g√®re la connexion √† votre base de donn√©es Supabase
// ============================================================================

import { createClient } from '@supabase/supabase-js';

// R√©cup√©ration des variables d'environnement
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

// V√©rification de la pr√©sence des cl√©s
if (!supabaseUrl || !supabaseAnonKey) {
  console.warn('‚ö†Ô∏è Supabase keys not found. Using mock mode.');
  console.warn('To use real database:');
  console.warn('1. Create a .env.local file at project root');
  console.warn('2. Add your Supabase URL and ANON KEY');
  console.warn('3. Restart the dev server');
}

// Cr√©ation du client Supabase
export const supabase = createClient(
  supabaseUrl || 'https://placeholder.supabase.co',
  supabaseAnonKey || 'placeholder-key',
  {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      storage: window.localStorage,
    },
    db: {
      schema: 'public',
    },
    global: {
      headers: {
        'x-application-name': 'CRMPro2x',
      },
    },
  }
);

// ============================================================================
// HELPERS POUR LA GESTION DES ERREURS
// ============================================================================

/**
 * G√®re les erreurs Supabase de mani√®re uniforme
 */
export const handleSupabaseError = (error: any, context: string) => {
  console.error(`Supabase Error in ${context}:`, error);
  
  if (error.message) {
    return {
      success: false,
      error: error.message,
      code: error.code || 'UNKNOWN_ERROR',
    };
  }
  
  return {
    success: false,
    error: 'An unknown error occurred',
    code: 'UNKNOWN_ERROR',
  };
};

/**
 * V√©rifie si le client Supabase est configur√© correctement
 */
export const isSupabaseConfigured = (): boolean => {
  return !!(supabaseUrl && supabaseAnonKey && 
    supabaseUrl !== 'https://placeholder.supabase.co' &&
    supabaseAnonKey !== 'placeholder-key');
};

// ============================================================================
// EXPORT DES TYPES SUPABASE (auto-g√©n√©r√©s)
// ============================================================================

export type Database = {
  public: {
    Tables: {
      users: {
        Row: {
          id: string;
          email: string;
          full_name: string | null;
          role: 'admin' | 'manager' | 'user';
          avatar_url: string | null;
          phone: string | null;
          department: string | null;
          created_at: string;
          updated_at: string;
        };
        Insert: Omit<Database['public']['Tables']['users']['Row'], 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Database['public']['Tables']['users']['Insert']>;
      };
      clients: {
        Row: {
          id: string;
          name: string;
          email: string | null;
          phone: string | null;
          company: string | null;
          address: string | null;
          city: string | null;
          country: string | null;
          status: 'active' | 'inactive' | 'prospect' | 'lead';
          source: string | null;
          assigned_to: string | null;
          total_revenue: number;
          notes: string | null;
          created_at: string;
          updated_at: string;
        };
        Insert: Omit<Database['public']['Tables']['clients']['Row'], 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Database['public']['Tables']['clients']['Insert']>;
      };
      products: {
        Row: {
          id: string;
          name: string;
          description: string | null;
          sku: string | null;
          category: string | null;
          price: number;
          cost: number | null;
          stock_quantity: number;
          min_stock_level: number;
          status: 'active' | 'inactive' | 'discontinued';
          image_url: string | null;
          created_at: string;
          updated_at: string;
        };
        Insert: Omit<Database['public']['Tables']['products']['Row'], 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Database['public']['Tables']['products']['Insert']>;
      };
      deals: {
        Row: {
          id: string;
          title: string;
          client_id: string | null;
          value: number;
          stage: 'prospecting' | 'qualification' | 'proposal' | 'negotiation' | 'closed_won' | 'closed_lost';
          probability: number;
          expected_close_date: string | null;
          assigned_to: string | null;
          notes: string | null;
          created_at: string;
          updated_at: string;
        };
        Insert: Omit<Database['public']['Tables']['deals']['Row'], 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Database['public']['Tables']['deals']['Insert']>;
      };
      projects: {
        Row: {
          id: string;
          name: string;
          description: string | null;
          client_id: string | null;
          status: 'planning' | 'in_progress' | 'on_hold' | 'completed' | 'cancelled';
          priority: 'low' | 'medium' | 'high' | 'urgent';
          start_date: string | null;
          end_date: string | null;
          budget: number | null;
          actual_cost: number;
          progress: number;
          manager_id: string | null;
          created_at: string;
          updated_at: string;
        };
        Insert: Omit<Database['public']['Tables']['projects']['Row'], 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Database['public']['Tables']['projects']['Insert']>;
      };
      tasks: {
        Row: {
          id: string;
          title: string;
          description: string | null;
          project_id: string | null;
          assigned_to: string | null;
          status: 'todo' | 'in_progress' | 'review' | 'done' | 'blocked';
          priority: 'low' | 'medium' | 'high' | 'urgent';
          due_date: string | null;
          estimated_hours: number | null;
          actual_hours: number | null;
          tags: string[] | null;
          created_at: string;
          updated_at: string;
        };
        Insert: Omit<Database['public']['Tables']['tasks']['Row'], 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Database['public']['Tables']['tasks']['Insert']>;
      };
      invoices: {
        Row: {
          id: string;
          invoice_number: string;
          client_id: string | null;
          project_id: string | null;
          issue_date: string;
          due_date: string;
          subtotal: number;
          tax_rate: number;
          tax_amount: number;
          total: number;
          status: 'draft' | 'sent' | 'paid' | 'overdue' | 'cancelled';
          payment_date: string | null;
          notes: string | null;
          created_at: string;
          updated_at: string;
        };
        Insert: Omit<Database['public']['Tables']['invoices']['Row'], 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Database['public']['Tables']['invoices']['Insert']>;
      };
      messages: {
        Row: {
          id: string;
          sender_id: string | null;
          recipient_id: string | null;
          subject: string | null;
          body: string;
          is_read: boolean;
          read_at: string | null;
          parent_id: string | null;
          created_at: string;
        };
        Insert: Omit<Database['public']['Tables']['messages']['Row'], 'id' | 'created_at'>;
        Update: Partial<Database['public']['Tables']['messages']['Insert']>;
      };
      activities: {
        Row: {
          id: string;
          user_id: string | null;
          action: string;
          entity_type: string;
          entity_id: string | null;
          description: string | null;
          metadata: Record<string, any> | null;
          ip_address: string | null;
          created_at: string;
        };
        Insert: Omit<Database['public']['Tables']['activities']['Row'], 'id' | 'created_at'>;
        Update: Partial<Database['public']['Tables']['activities']['Insert']>;
      };
    };
  };
};

// ============================================================================
// LOG DE STATUS
// ============================================================================
if (isSupabaseConfigured()) {
  console.log('‚úÖ Supabase client configured successfully');
  console.log('üìä Connected to:', supabaseUrl);
} else {
  console.log('‚ö†Ô∏è Supabase client running in MOCK mode');
  console.log('üí° Add your credentials to .env.local to use real database');
}

export default supabase;
```

### Action 3.4 : Sauvegarder le fichier

Enregistrez le fichier (Ctrl+S ou Cmd+S).

‚úÖ **√âTAPE 3 TERMIN√âE**

---

## üöÄ √âTAPE 4 : RED√âMARRER LE SERVEUR

### Action 4.1 : Arr√™ter le serveur actuel

Si votre serveur de d√©veloppement est en cours d'ex√©cution :

**Dans le terminal, appuyez sur :**
```
Ctrl + C
```

Attendez que le serveur s'arr√™te compl√®tement.

### Action 4.2 : Red√©marrer le serveur

Ex√©cutez :

```bash
npm run dev
```

**R√©sultat attendu :**
```
  VITE v5.4.0  ready in 543 ms

  ‚ûú  Local:   http://localhost:5173/
  ‚ûú  Network: use --host to expose
  ‚ûú  press h + enter to show help
```

### Action 4.3 : V√©rifier les logs de console

Dans la console du terminal, vous devriez voir :

```
‚úÖ Supabase client configured successfully
üìä Connected to: https://votre-projet.supabase.co
```

‚ö†Ô∏è **Si vous voyez :**
```
‚ö†Ô∏è Supabase client running in MOCK mode
üí° Add your credentials to .env.local to use real database
```

**‚Üí Cela signifie que vos cl√©s ne sont pas d√©tect√©es. V√©rifiez :**
1. Le fichier `.env.local` est √† la racine du projet
2. Les noms des variables commencent par `VITE_`
3. Il n'y a pas d'espaces avant/apr√®s les valeurs
4. Vous avez bien red√©marr√© le serveur

‚úÖ **√âTAPE 4 TERMIN√âE**

---

## üß™ √âTAPE 5 : TESTER LA CONNEXION

### Action 5.1 : Ouvrir l'application

Ouvrez votre navigateur et allez sur :
```
http://localhost:5173
```

### Action 5.2 : Ouvrir la console du navigateur

**Chrome/Edge/Brave :**
- Appuyez sur `F12` ou
- Clic droit ‚Üí Inspecter ‚Üí Console

**Firefox :**
- Appuyez sur `F12` ou
- Clic droit ‚Üí Inspecter l'√©l√©ment ‚Üí Console

**Safari :**
- Cmd+Option+C ou
- D√©veloppement ‚Üí Afficher la console JavaScript

### Action 5.3 : V√©rifier les messages de connexion

Dans la console, vous devriez voir :

```javascript
‚úÖ Supabase client configured successfully
üìä Connected to: https://votre-projet.supabase.co
```

### Action 5.4 : Tester une requ√™te simple

Dans la console du navigateur, ex√©cutez cette commande pour tester :

```javascript
// Tester la connexion
const { data, error } = await window.supabase.from('clients').select('count');
console.log('Test result:', { data, error });
```

**R√©sultat attendu :**
```javascript
Test result: { data: [{count: 2}], error: null }
```

Si vous voyez `error: null`, c'est que la connexion fonctionne ! üéâ

‚úÖ **√âTAPE 5 TERMIN√âE**

---

## ‚úÖ V√âRIFICATION FINALE

Cochez chaque √©l√©ment pour confirmer que la Phase 2 est compl√®te :

- [ ] Package @supabase/supabase-js install√©
- [ ] Fichier .env.local cr√©√© √† la racine
- [ ] Vraies cl√©s Supabase ajout√©es
- [ ] .env.local est dans .gitignore
- [ ] Fichier client.ts mis √† jour
- [ ] Serveur red√©marr√©
- [ ] Message de succ√®s dans la console terminal
- [ ] Message de succ√®s dans la console navigateur
- [ ] Test de requ√™te r√©ussi

---

## üéâ PHASE 2 TERMIN√âE !

Votre application CRMPro2x est maintenant connect√©e √† votre base de donn√©es Supabase r√©elle !

**Ce qui fonctionne maintenant :**
- ‚úÖ Connexion √† Supabase √©tablie
- ‚úÖ Types TypeScript configur√©s
- ‚úÖ Gestion d'erreurs en place
- ‚úÖ Pr√™t pour les requ√™tes de donn√©es

**Prochaine √©tape :**
‚Üí **PHASE 3** : S√©curisation avec Row Level Security (RLS)

---

## üÜò D√âPANNAGE

### Probl√®me 1 : "Cannot find module '@supabase/supabase-js'"

**Solution :**
```bash
# Supprimer node_modules
rm -rf node_modules
rm package-lock.json

# R√©installer
npm install
npm install @supabase/supabase-js
```

### Probl√®me 2 : "VITE_SUPABASE_URL is undefined"

**Solution :**
1. V√©rifiez que `.env.local` est √† la **racine** (pas dans src/)
2. V√©rifiez que les variables commencent par `VITE_`
3. Red√©marrez le serveur (`npm run dev`)

### Probl√®me 3 : "Invalid API key"

**Solution :**
1. Retournez dans Supabase ‚Üí Settings ‚Üí API
2. V√©rifiez que vous utilisez la cl√© **anon public** (pas service_role)
3. Copiez √† nouveau la cl√© compl√®te (sans espaces)
4. Red√©marrez le serveur

### Probl√®me 4 : Les logs ne s'affichent pas

**Solution :**
1. Ouvrez `src/integrations/supabase/client.ts`
2. V√©rifiez que les lignes console.log() sont pr√©sentes √† la fin
3. Videz le cache du navigateur (Ctrl+Shift+Delete)
4. Rechargez la page (Ctrl+R ou F5)

---

## üìû BESOIN D'AIDE ?

Si vous √™tes bloqu√© :

1. **V√©rifiez les logs** :
   - Terminal : Erreurs de compilation
   - Console navigateur : Erreurs JavaScript

2. **V√©rifiez Supabase** :
   - Dashboard ‚Üí Settings ‚Üí API
   - Les cl√©s sont-elles correctes ?

3. **Consultez la documentation** :
   - https://supabase.com/docs/reference/javascript

---

**Pr√™t pour la Phase 3 ? Continuez vers la s√©curisation ! üîí**# üîß PHASE 2 : CONFIGURATION DU PROJET - GUIDE D√âTAILL√â

## üìã OBJECTIF DE CETTE PHASE

Connecter votre application CRMPro2x React √† votre base de donn√©es Supabase en configurant :
1. Les d√©pendances n√©cessaires
2. Les variables d'environnement
3. Le client Supabase
4. La v√©rification de la connexion

**Dur√©e estim√©e : 10-15 minutes**

---

## ‚úÖ PR√âREQUIS

Avant de commencer la Phase 2, assurez-vous que :

- [ ] La Phase 1 est termin√©e (base de donn√©es cr√©√©e dans Supabase)
- [ ] Vous avez not√© votre **SUPABASE_URL**
- [ ] Vous avez not√© votre **SUPABASE_ANON_KEY**
- [ ] Votre projet CRMPro2x est ouvert dans votre √©diteur de code
- [ ] Un terminal est ouvert √† la racine du projet

---

## üì¶ √âTAPE 1 : INSTALLER LES D√âPENDANCES

### Action 1.1 : Installer Supabase Client

Ouvrez un terminal √† la racine de votre projet et ex√©cutez :

```bash
npm install @supabase/supabase-js
```

**R√©sultat attendu :**
```
added 1 package, and audited 523 packages in 3s

154 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities
```

### Action 1.2 : V√©rifier l'installation

V√©rifiez que le package est bien install√© :

```bash
npm list @supabase/supabase-js
```

**R√©sultat attendu :**
```
crmpro2x@1.0.0 /chemin/vers/votre/projet
‚îî‚îÄ‚îÄ @supabase/supabase-js@2.x.x
```

‚úÖ **√âTAPE 1 TERMIN√âE**

---

## üîê √âTAPE 2 : CONFIGURER LES VARIABLES D'ENVIRONNEMENT

### Action 2.1 : Cr√©er le fichier .env.local

√Ä la **racine de votre projet** (m√™me niveau que package.json), cr√©ez un nouveau fichier nomm√© `.env.local`

**Structure du projet :**
```
crmpro2x/
‚îú‚îÄ‚îÄ node_modules/
‚îú‚îÄ‚îÄ public/
‚îú‚îÄ‚îÄ src/
‚îú‚îÄ‚îÄ .env.local          ‚Üê CR√âEZ CE FICHIER ICI
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ vite.config.ts
‚îî‚îÄ‚îÄ ...
```

### Action 2.2 : Ajouter vos cl√©s Supabase

Copiez-collez ce contenu dans `.env.local` :

```env
# Configuration Supabase pour CRMPro2x
VITE_SUPABASE_URL=https://votre-projet.supabase.co
VITE_SUPABASE_ANON_KEY=votre_cle_anonyme_ici
```

### Action 2.3 : Remplacer par vos vraies cl√©s

**IMPORTANT** : Remplacez les valeurs par vos vraies cl√©s r√©cup√©r√©es en Phase 1.

**O√π trouver vos cl√©s ?**
1. Allez sur https://supabase.com
2. S√©lectionnez votre projet
3. Cliquez sur **Settings** (‚öôÔ∏è) en bas de la barre lat√©rale
4. Allez dans **API**
5. Copiez :
   - **Project URL** ‚Üí `VITE_SUPABASE_URL`
   - **anon public** ‚Üí `VITE_SUPABASE_ANON_KEY`

**Exemple de fichier .env.local correctement rempli :**
```env
VITE_SUPABASE_URL=https://xyzcompany.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5emNvbXBhbnkiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTYzOTU4OTI0MCwiZXhwIjoxOTU1MTY1MjQwfQ.abc123def456ghi789jkl012mno345pqr678stu901vwx234
```

### Action 2.4 : V√©rifier que .env.local est ignor√© par Git

Ouvrez votre fichier `.gitignore` et v√©rifiez que cette ligne est pr√©sente :

```
.env.local
```

Si elle n'y est pas, ajoutez-la !

‚ö†Ô∏è **CRITIQUE** : Ne commitez JAMAIS le fichier .env.local dans Git !

‚úÖ **√âTAPE 2 TERMIN√âE**

---

## üìù √âTAPE 3 : CONFIGURER LE CLIENT SUPABASE

### Action 3.1 : Localiser le fichier client existant

Dans votre projet, naviguez vers :
```
src/integrations/supabase/client.ts
```

### Action 3.2 : Sauvegarder l'ancien fichier (optionnel)

Si vous voulez garder une copie de l'ancien fichier :

**Option A - Via terminal :**
```bash
cp src/integrations/supabase/client.ts src/integrations/supabase/client.ts.backup
```

**Option B - Via √©diteur :**
Dupliquez le fichier et renommez-le `client.ts.backup`

### Action 3.3 : Remplacer par le nouveau client

Ouvrez `src/integrations/supabase/client.ts` et **REMPLACEZ TOUT LE CONTENU** par le code suivant :

```typescript
// ============================================================================
// CLIENT SUPABASE - Configuration pour CRMPro2x
// ============================================================================
// Ce fichier g√®re la connexion √† votre base de donn√©es Supabase
// ============================================================================

import { createClient } from '@supabase/supabase-js';

// R√©cup√©ration des variables d'environnement
const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

// V√©rification de la pr√©sence des cl√©s
if (!supabaseUrl || !supabaseAnonKey) {
  console.warn('‚ö†Ô∏è Supabase keys not found. Using mock mode.');
  console.warn('To use real database:');
  console.warn('1. Create a .env.local file at project root');
  console.warn('2. Add your Supabase URL and ANON KEY');
  console.warn('3. Restart the dev server');
}

// Cr√©ation du client Supabase
export const supabase = createClient(
  supabaseUrl || 'https://placeholder.supabase.co',
  supabaseAnonKey || 'placeholder-key',
  {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      storage: window.localStorage,
    },
    db: {
      schema: 'public',
    },
    global: {
      headers: {
        'x-application-name': 'CRMPro2x',
      },
    },
  }
);

// ============================================================================
// HELPERS POUR LA GESTION DES ERREURS
// ============================================================================

/**
 * G√®re les erreurs Supabase de mani√®re uniforme
 */
export const handleSupabaseError = (error: any, context: string) => {
  console.error(`Supabase Error in ${context}:`, error);
  
  if (error.message) {
    return {
      success: false,
      error: error.message,
      code: error.code || 'UNKNOWN_ERROR',
    };
  }
  
  return {
    success: false,
    error: 'An unknown error occurred',
    code: 'UNKNOWN_ERROR',
  };
};

/**
 * V√©rifie si le client Supabase est configur√© correctement
 */
export const isSupabaseConfigured = (): boolean => {
  return !!(supabaseUrl && supabaseAnonKey && 
    supabaseUrl !== 'https://placeholder.supabase.co' &&
    supabaseAnonKey !== 'placeholder-key');
};

// ============================================================================
// EXPORT DES TYPES SUPABASE (auto-g√©n√©r√©s)
// ============================================================================

export type Database = {
  public: {
    Tables: {
      users: {
        Row: {
          id: string;
          email: string;
          full_name: string | null;
          role: 'admin' | 'manager' | 'user';
          avatar_url: string | null;
          phone: string | null;
          department: string | null;
          created_at: string;
          updated_at: string;
        };
        Insert: Omit<Database['public']['Tables']['users']['Row'], 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Database['public']['Tables']['users']['Insert']>;
      };
      clients: {
        Row: {
          id: string;
          name: string;
          email: string | null;
          phone: string | null;
          company: string | null;
          address: string | null;
          city: string | null;
          country: string | null;
          status: 'active' | 'inactive' | 'prospect' | 'lead';
          source: string | null;
          assigned_to: string | null;
          total_revenue: number;
          notes: string | null;
          created_at: string;
          updated_at: string;
        };
        Insert: Omit<Database['public']['Tables']['clients']['Row'], 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Database['public']['Tables']['clients']['Insert']>;
      };
      products: {
        Row: {
          id: string;
          name: string;
          description: string | null;
          sku: string | null;
          category: string | null;
          price: number;
          cost: number | null;
          stock_quantity: number;
          min_stock_level: number;
          status: 'active' | 'inactive' | 'discontinued';
          image_url: string | null;
          created_at: string;
          updated_at: string;
        };
        Insert: Omit<Database['public']['Tables']['products']['Row'], 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Database['public']['Tables']['products']['Insert']>;
      };
      deals: {
        Row: {
          id: string;
          title: string;
          client_id: string | null;
          value: number;
          stage: 'prospecting' | 'qualification' | 'proposal' | 'negotiation' | 'closed_won' | 'closed_lost';
          probability: number;
          expected_close_date: string | null;
          assigned_to: string | null;
          notes: string | null;
          created_at: string;
          updated_at: string;
        };
        Insert: Omit<Database['public']['Tables']['deals']['Row'], 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Database['public']['Tables']['deals']['Insert']>;
      };
      projects: {
        Row: {
          id: string;
          name: string;
          description: string | null;
          client_id: string | null;
          status: 'planning' | 'in_progress' | 'on_hold' | 'completed' | 'cancelled';
          priority: 'low' | 'medium' | 'high' | 'urgent';
          start_date: string | null;
          end_date: string | null;
          budget: number | null;
          actual_cost: number;
          progress: number;
          manager_id: string | null;
          created_at: string;
          updated_at: string;
        };
        Insert: Omit<Database['public']['Tables']['projects']['Row'], 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Database['public']['Tables']['projects']['Insert']>;
      };
      tasks: {
        Row: {
          id: string;
          title: string;
          description: string | null;
          project_id: string | null;
          assigned_to: string | null;
          status: 'todo' | 'in_progress' | 'review' | 'done' | 'blocked';
          priority: 'low' | 'medium' | 'high' | 'urgent';
          due_date: string | null;
          estimated_hours: number | null;
          actual_hours: number | null;
          tags: string[] | null;
          created_at: string;
          updated_at: string;
        };
        Insert: Omit<Database['public']['Tables']['tasks']['Row'], 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Database['public']['Tables']['tasks']['Insert']>;
      };
      invoices: {
        Row: {
          id: string;
          invoice_number: string;
          client_id: string | null;
          project_id: string | null;
          issue_date: string;
          due_date: string;
          subtotal: number;
          tax_rate: number;
          tax_amount: number;
          total: number;
          status: 'draft' | 'sent' | 'paid' | 'overdue' | 'cancelled';
          payment_date: string | null;
          notes: string | null;
          created_at: string;
          updated_at: string;
        };
        Insert: Omit<Database['public']['Tables']['invoices']['Row'], 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Database['public']['Tables']['invoices']['Insert']>;
      };
      messages: {
        Row: {
          id: string;
          sender_id: string | null;
          recipient_id: string | null;
          subject: string | null;
          body: string;
          is_read: boolean;
          read_at: string | null;
          parent_id: string | null;
          created_at: string;
        };
        Insert: Omit<Database['public']['Tables']['messages']['Row'], 'id' | 'created_at'>;
        Update: Partial<Database['public']['Tables']['messages']['Insert']>;
      };
      activities: {
        Row: {
          id: string;
          user_id: string | null;
          action: string;
          entity_type: string;
          entity_id: string | null;
          description: string | null;
          metadata: Record<string, any> | null;
          ip_address: string | null;
          created_at: string;
        };
        Insert: Omit<Database['public']['Tables']['activities']['Row'], 'id' | 'created_at'>;
        Update: Partial<Database['public']['Tables']['activities']['Insert']>;
      };
    };
  };
};

// ============================================================================
// LOG DE STATUS
// ============================================================================
if (isSupabaseConfigured()) {
  console.log('‚úÖ Supabase client configured successfully');
  console.log('üìä Connected to:', supabaseUrl);
} else {
  console.log('‚ö†Ô∏è Supabase client running in MOCK mode');
  console.log('üí° Add your credentials to .env.local to use real database');
}

export default supabase;
```

### Action 3.4 : Sauvegarder le fichier

Enregistrez le fichier (Ctrl+S ou Cmd+S).

‚úÖ **√âTAPE 3 TERMIN√âE**

---

## üöÄ √âTAPE 4 : RED√âMARRER LE SERVEUR

### Action 4.1 : Arr√™ter le serveur actuel

Si votre serveur de d√©veloppement est en cours d'ex√©cution :

**Dans le terminal, appuyez sur :**
```
Ctrl + C
```

Attendez que le serveur s'arr√™te compl√®tement.

### Action 4.2 : Red√©marrer le serveur

Ex√©cutez :

```bash
npm run dev
```

**R√©sultat attendu :**
```
  VITE v5.4.0  ready in 543 ms

  ‚ûú  Local:   http://localhost:5173/
  ‚ûú  Network: use --host to expose
  ‚ûú  press h + enter to show help
```

### Action 4.3 : V√©rifier les logs de console

Dans la console du terminal, vous devriez voir :

```
‚úÖ Supabase client configured successfully
üìä Connected to: https://votre-projet.supabase.co
```

‚ö†Ô∏è **Si vous voyez :**
```
‚ö†Ô∏è Supabase client running in MOCK mode
üí° Add your credentials to .env.local to use real database
```

**‚Üí Cela signifie que vos cl√©s ne sont pas d√©tect√©es. V√©rifiez :**
1. Le fichier `.env.local` est √† la racine du projet
2. Les noms des variables commencent par `VITE_`
3. Il n'y a pas d'espaces avant/apr√®s les valeurs
4. Vous avez bien red√©marr√© le serveur

‚úÖ **√âTAPE 4 TERMIN√âE**

---

## üß™ √âTAPE 5 : TESTER LA CONNEXION

### Action 5.1 : Ouvrir l'application

Ouvrez votre navigateur et allez sur :
```
http://localhost:5173
```

### Action 5.2 : Ouvrir la console du navigateur

**Chrome/Edge/Brave :**
- Appuyez sur `F12` ou
- Clic droit ‚Üí Inspecter ‚Üí Console

**Firefox :**
- Appuyez sur `F12` ou
- Clic droit ‚Üí Inspecter l'√©l√©ment ‚Üí Console

**Safari :**
- Cmd+Option+C ou
- D√©veloppement ‚Üí Afficher la console JavaScript

### Action 5.3 : V√©rifier les messages de connexion

Dans la console, vous devriez voir :

```javascript
‚úÖ Supabase client configured successfully
üìä Connected to: https://votre-projet.supabase.co
```

### Action 5.4 : Tester une requ√™te simple

Dans la console du navigateur, ex√©cutez cette commande pour tester :

```javascript
// Tester la connexion
const { data, error } = await window.supabase.from('clients').select('count');
console.log('Test result:', { data, error });
```

**R√©sultat attendu :**
```javascript
Test result: { data: [{count: 2}], error: null }
```

Si vous voyez `error: null`, c'est que la connexion fonctionne ! üéâ

‚úÖ **√âTAPE 5 TERMIN√âE**

---

## ‚úÖ V√âRIFICATION FINALE

Cochez chaque √©l√©ment pour confirmer que la Phase 2 est compl√®te :

- [ ] Package @supabase/supabase-js install√©
- [ ] Fichier .env.local cr√©√© √† la racine
- [ ] Vraies cl√©s Supabase ajout√©es
- [ ] .env.local est dans .gitignore
- [ ] Fichier client.ts mis √† jour
- [ ] Serveur red√©marr√©
- [ ] Message de succ√®s dans la console terminal
- [ ] Message de succ√®s dans la console navigateur
- [ ] Test de requ√™te r√©ussi

---

## üéâ PHASE 2 TERMIN√âE !

Votre application CRMPro2x est maintenant connect√©e √† votre base de donn√©es Supabase r√©elle !

**Ce qui fonctionne maintenant :**
- ‚úÖ Connexion √† Supabase √©tablie
- ‚úÖ Types TypeScript configur√©s
- ‚úÖ Gestion d'erreurs en place
- ‚úÖ Pr√™t pour les requ√™tes de donn√©es

**Prochaine √©tape :**
‚Üí **PHASE 3** : S√©curisation avec Row Level Security (RLS)

---

## üÜò D√âPANNAGE

### Probl√®me 1 : "Cannot find module '@supabase/supabase-js'"

**Solution :**
```bash
# Supprimer node_modules
rm -rf node_modules
rm package-lock.json

# R√©installer
npm install
npm install @supabase/supabase-js
```

### Probl√®me 2 : "VITE_SUPABASE_URL is undefined"

**Solution :**
1. V√©rifiez que `.env.local` est √† la **racine** (pas dans src/)
2. V√©rifiez que les variables commencent par `VITE_`
3. Red√©marrez le serveur (`npm run dev`)

### Probl√®me 3 : "Invalid API key"

**Solution :**
1. Retournez dans Supabase ‚Üí Settings ‚Üí API
2. V√©rifiez que vous utilisez la cl√© **anon public** (pas service_role)
3. Copiez √† nouveau la cl√© compl√®te (sans espaces)
4. Red√©marrez le serveur

### Probl√®me 4 : Les logs ne s'affichent pas

**Solution :**
1. Ouvrez `src/integrations/supabase/client.ts`
2. V√©rifiez que les lignes console.log() sont pr√©sentes √† la fin
3. Videz le cache du navigateur (Ctrl+Shift+Delete)
4. Rechargez la page (Ctrl+R ou F5)

---

## üìû BESOIN D'AIDE ?

Si vous √™tes bloqu√© :

1. **V√©rifiez les logs** :
   - Terminal : Erreurs de compilation
   - Console navigateur : Erreurs JavaScript

2. **V√©rifiez Supabase** :
   - Dashboard ‚Üí Settings ‚Üí API
   - Les cl√©s sont-elles correctes ?

3. **Consultez la documentation** :
   - https://supabase.com/docs/reference/javascript

---

**Pr√™t pour la Phase 3 ? Continuez vers la s√©curisation ! üîí**